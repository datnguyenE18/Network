# HAProxy

- **HAProxy** là một proxy server, load blancer, system monitoring, được sinh ra để làm nhiệm vụ của một front end web service.

  Là một phần mềm sử dụng trong việc cân bằng tải, chạy trên Linux, Solaris và FreeBSD. Người dùng có thể sử dụng HAProxy để cải thiện suất hoàn thiện của các trang web và ứng dụng bằng cách phân tán khối lượng công việc của chúng trên nhiều máy chủ.
 
- HAProxy cũng được sử dụng trong các hệ thống lớn có lưu lượng truy cập cao như GitHub, Twitter, Reddit, Bitbucket, Stack Overflow,…



![tinh-nang-cua-haproxy](https://user-images.githubusercontent.com/43572616/177666641-5dfc3b55-718a-4002-9b14-465ef62204c8.png)

***

- **Khi nào sử dụng HAProxy**
  - Khi  làm việc với dự án nhỏ, web app chỉ cần viết bằng NodeJS dùng Pm2 để có thể chạy multithread sau đó dùng Nginx để serve static file, làm proxy cho nodejs là được. Rất ít khi lỗi, quá tải vì cơ bản là một app nhỏ, nếu sập cũng chỉ cần restart lại
 
  - Khi bước vào một công ty, phải đối mặt với những vấn đề mới, khi lượng request lên tới hàng ngìn request/s thì việc scale hệ thống như thế nào để có thể đáp ứng được lượng request đó là một vấn đề cần phải giải quyết.

    Về cơ bản, khi lượng request nhiều lên, sẽ có thể lựa chọn hai loại hình scale cho hệ thống đó là scale ngang và scale dọc
    - scale dọc tức là nâng cấp HDD lên SSD dung lượng cao, nâng cấp RAM, Vi xử lí… (đắt, chi phí cao)
 
    - Scale theo chiều ngang tức là dùng thêm nhiều hệ thống tương tự như hệ thống hiện tại để chia nhau xử lí request.



Thường khi scale sẽ kết hợp cả hai kiểu scale sao cho hợp lí nhất và ít chi phí nhất. Đến đây khi các hệ thống hoạt động cùng với nhau, nảy sinh ra vấn đề làm sao để giao request này cho hệ thống kia xử lí

Haproxy sinh ra để giải quyết vấn đề này, haproxy sẽ làm vai trò của một proxy server, theo dõi tình trạng các node và sẽ gửi request đến các node

***

- **Tính năng của HAProxy:**
  - Hỗ trợ cân bằng tải ở lớp 4 và lớp 7 (tương ứng với TCP và HTTP).
  - Support HTTP protocol, HTTP / 2, gRPC, FastCGI.
  - Chấm dứt SSL / TLS.
  - Lưu trữ chứng chỉ SSL động.
  - Chuyển đổi nội dung và kiểm tra.
  - Ủy quyền minh bạch.
  - Ghi nhật ký chi tiết.
  - CLI.
  - Xác thực HTTP.
  - Đa luồng.
  - Rewrite URL.
  - Kiểm tra sức khỏe nâng cao.
  - Giới hạn tần số kết nối.

***

- **Bảo mật:**
  - HAProxy được coi là an toàn, nó có rất ít lỗ hổng trong các năm qua
 
  - Nó chứa các tính năng có thể hạn chế tấn công như cô lập chính nó sử dụng chroot, drop ngay user/group không có các quyền đặc biệt khi khởi động và tránh truy cập vào ổ cứng khi khởi động.
 
  - HAProxy cũng có thể được sử dụng để bảo mật cho các hệ thống khác, ví dụ như: HAProxy theo dõi lưu lượng truy cập và giám sát hành vi của khách hàng thông qua các yêu cầu, sau đó có thể chặn khách hàng đó nếu thấy khả nghi. Người dùng có thể cấu hình ACL, xác định các chính sách để kiểm tra dữ liệu của các truy cập. Nó cũng có thể giới hạn tốc độ và danh sách IP Blacklist/Whitelist

***

**Sticky session:**
  - Trong môi trường web, nhiều khi chúng ta cần cố định session của user, như để duy trì trạng thái login. Khi đó, chúng ta cần cố định session trên một server
 
  - HAProxy hỗ trợ một số thuật toán Load Balancing duy trì trạng thái kết nối mà cho phép cố định session như hdr, rdp-cookie, source, uri hoặc url\_param. Ví dụ:

|backend cms<br>`    `balance source<br>`    `hash-type consistent<br>`    `server web1 192.168.10.110:8080 check<br>`    `server web2 192.168.10.111:8080 check<br>`    `server web3 192.168.10.112:8080 check|
| :- |


- Nếu muốn cố định session mà vẫn sử dụng các thuật toán load balancing như roundrobin, leastconn, hoặc static-rr, khi đó sử dụng “Sticky Session”. Sticky session cho phép cố định session của users mà sử dụng cookie, và HAProxy sẽ điều phối để luôn request từ một user đến cùng một server.
 
- Để sử dụng sticky session trong HAProxy, chúng ta thêm tùy chọn “cookie cookie\_name insert/prefix” vào trong phần backend.
  - Khi đó sử dụng ‘cookie cookie\_name insert <options>’. “cookie\_name” là giá trị mà HAProxy sẽ chèn vào (insert). Khi client quay lại (tức là cũng là client này và request tiếp theo), HAProxy sẽ biết được server nào để chọn cho client này. Ví dụ:

|`  `cookie  WEB insert<br>`    `server web1 192.168.1.110:8080 cookie web1 check<br>`    `server web2 192.168.1.111:8080 cookie web2 check<br>`    `server web3 192.168.1.112:8080 cookie web3 check|
| :- |


- Khi sử dụng insert, HAProxy phản hồi cho client là “WEB=web1”

***

- **Hạn chế:** Với sticky session, việc các request từ một user sẽ chỉ cố định vào một server. Vì vậy mà sẽ không đảm bảo được tính điều phối nhiều request từ một users đến nhiều server. Để khắc phục điểm hạn chế này, thì hiện nay có một số phần mềm như redis, memcached, … cho phép lưu session của user, còn việc điều phối các request của user thì vẫn thực hiện bình thường đến các server.

***

- **Health Check:**
  - HAProxy sử dụng health check để phát hiện các backend server sẵn sàng xử lý request. Kỹ thuật này sẽ tránh việc loại bỏ server khỏi backend thủ công khi backend server không sẵn sàng. health check sẽ cố gắng thiết lập kết nối TCP tới server để kiểm tra backend server có sẵn sàng xử lý request.
 
  - Nếu health check không thể kết nối tới server, nó sẽ tự động loại bỏ server khởi backend, các traffic tới sẽ không được forward tới server cho đến khi nó có thể thực hiện được health check. Nếu tất cả server thuộc backend đều xảy vấn đề, dịch vụ sẽ trở trên không khả dụ (trả lại status code 500) cho đến khi 1 server thuộc backend từ trạng thái không khả dụ chuyển sang trạng thái sẵn sàng.
